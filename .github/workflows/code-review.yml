#heavens-above/.github/workflows/code-review.yml
name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Lint
        id: lint
        continue-on-error: true
        run: |
          npm run lint > lint.txt 2>&1 || echo "code=$?" >> $GITHUB_OUTPUT
          if [ ! -f lint.txt ]; then
            touch lint.txt
          fi

      - name: Audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit.json 2>&1 || true
          if [ -f audit.json ]; then
            VULNS=$(node -e "try { const fs=require('fs'); const a=JSON.parse(fs.readFileSync('audit.json')); console.log(a.metadata?.vulnerabilities?.total || 0); } catch(e) { console.log(0); }" 2>/dev/null || echo "0")
            echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: review-reports
          path: |
            lint.txt
            audit.json

      - name: Comment
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let body = '## Code Review Results\n\n';
            
            // Lint results
            try {
              if (fs.existsSync('lint.txt')) {
                const lint = fs.readFileSync('lint.txt', 'utf8').trim();
                if (lint && lint.length > 0) {
                  body += `### ESLint Issues\n\`\`\`\n${lint.substring(0, 2000)}\n\`\`\`\n\n`;
                } else {
                  body += '### ESLint: No issues ✅\n\n';
                }
              } else {
                body += '### ESLint: No issues ✅\n\n';
              }
            } catch (e) {
              body += '### ESLint: No issues ✅\n\n';
            }
            
            // Security audit results
            try {
              if (fs.existsSync('audit.json')) {
                const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
                const vulns = audit.metadata?.vulnerabilities || {};
                if (vulns.total > 0) {
                  body += `### Security Audit: ⚠️ ${vulns.total} vulnerabilities found\n`;
                  body += `- Critical: ${vulns.critical || 0}\n`;
                  body += `- High: ${vulns.high || 0}\n`;
                  body += `- Moderate: ${vulns.moderate || 0}\n`;
                  body += `- Low: ${vulns.low || 0}\n\n`;
                } else {
                  body += '### Security Audit: No vulnerabilities ✅\n\n';
                }
              } else {
                body += '### Security Audit: No vulnerabilities ✅\n\n';
              }
            } catch (e) {
              body += '### Security Audit: Unable to parse results\n\n';
            }
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } catch (e) {
              console.log('Failed to create comment:', e.message);
            }

      - name: Fail if lint errors
        if: steps.lint.outputs.code != '0'
        run: exit 1

      - name: Fail if security vulnerabilities
        if: steps.audit.outputs.vulnerabilities != '0' && steps.audit.outputs.vulnerabilities != ''
        run: |
          echo "Security vulnerabilities found. Please review and fix before merging."
          exit 1